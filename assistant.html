<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>ç†ç‰ŒåŠ©æ‰‹</title>
    <style>
        body { margin: 0; font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; transition: background-color 0.3s ease; color: white; overflow: hidden; }
        #upload-container { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background-color: #121212; }
        #upload-label { padding: 20px 40px; border: 2px dashed #555; border-radius: 10px; cursor: pointer; font-size: 1.5em; transition: all 0.2s ease; }
        #upload-label:hover { background-color: #333; border-color: #888; }
        #upload-label.drag-over { background-color: #444; border-color: #4fc3f7; transform: scale(1.02); }
        #file-input { display: none; }
        #loading-spinner { display: none; font-size: 2em; }
        #assistant-container { display: none; flex-direction: column; height: 100vh; width: 100vw; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        #card-display { text-align: center; user-select: none; }
        #rank { font-size: 20vw; font-weight: bold; line-height: 1; }
        #suit { font-size: 15vw; line-height: 1; }
        #status, #message { font-size: 2em; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); margin-top: 20px; }
        #controls { display: flex; flex-direction: column; align-items: center; gap: 15px; background-color: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 10px; margin-top: 30px; border: 1px solid rgba(255, 255, 255, 0.5); }
        .control-group { display: flex; align-items: center; gap: 10px; font-size: 1.2em; }
        #speed-slider { width: 200px; }
        #toggle-autoplay-btn { padding: 10px 20px; font-size: 1.2em; border: none; border-radius: 5px; color: white; cursor: pointer; transition: background-color 0.2s; background-color: #1a73e8; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        #toggle-autoplay-btn:hover { filter: brightness(1.2); }
        .bg-red-card { background-color: #d93025; }
        .bg-blue-card { background-color: #1a73e8; }
        .font-red { color: #dc3545; }
        .font-black { color: #212529; }

        /* æª”æ¡ˆç®¡ç†å€åŸŸ */
        #file-manager { display: none; position: fixed; top: 10px; left: 10px; background-color: rgba(0, 0, 0, 0.8); padding: 15px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.3); z-index: 1000; max-width: 300px; }
        #file-manager h3 { margin: 0 0 10px 0; color: white; font-size: 1.2em; }
        #saved-files-list { max-height: 200px; overflow-y: auto; margin-bottom: 10px; }
        .file-item { display: flex; align-items: center; justify-content: space-between; padding: 8px; margin: 5px 0; background-color: rgba(255, 255, 255, 0.1); border-radius: 5px; font-size: 0.9em; }
        .file-name { flex: 1; margin-right: 10px; cursor: pointer; color: #4fc3f7; }
        .file-name:hover { text-decoration: underline; }
        .file-actions { display: flex; gap: 5px; }
        .file-btn { padding: 2px 6px; font-size: 0.8em; border: none; border-radius: 3px; cursor: pointer; color: white; }
        .rename-btn { background-color: #ff9800; }
        .delete-btn { background-color: #f44336; }
        #save-current-btn { padding: 8px 12px; background-color: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%; margin-bottom: 10px; }
        #toggle-manager-btn { position: fixed; top: 10px; right: 10px; padding: 10px; background-color: rgba(0, 0, 0, 0.7); color: white; border: none; border-radius: 50%; cursor: pointer; z-index: 1001; font-size: 1.2em; }
        
        /* é‡æ–°å‘½åå°è©±æ¡† */
        #rename-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 2000; }
        #rename-dialog { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #333; padding: 20px; border-radius: 10px; color: white; }
        #rename-input { padding: 10px; margin: 10px 0; width: 250px; border: none; border-radius: 5px; }
        #rename-buttons { display: flex; gap: 10px; justify-content: center; }
        #rename-confirm, #rename-cancel { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; }
        #rename-confirm { background-color: #4caf50; color: white; }
        #rename-cancel { background-color: #757575; color: white; }
    </style>
</head>
<body>
    <!-- 1. ä¸Šå‚³ä»‹é¢ -->
    <div id="upload-container">
        <label for="file-input" id="upload-label">é»æ“Šæ­¤è™•ï¼Œé¸æ“‡ Excel æª”æ¡ˆ<br><small>æˆ–ç›´æ¥æ‹–æ”¾æª”æ¡ˆåˆ°æ­¤å€åŸŸ</small></label>
        <div style="margin-top: 10px; font-size: 0.9em; color: #aaa; text-align: center;">
            ğŸ’¡ æç¤ºï¼šå¦‚æœé–‹å•Ÿçš„ä¸æ˜¯æ‚¨è¦çš„è³‡æ–™å¤¾ï¼Œè«‹åœ¨æª”æ¡ˆé¸æ“‡å™¨ä¸­å°èˆªåˆ°æ­£ç¢ºä½ç½®
        </div>
        <input type="file" id="file-input" accept=".xlsx">
        
        <!-- è¼‰å…¥å·²å„²å­˜æª”æ¡ˆæŒ‰éˆ• -->
        <button id="load-saved-btn" style="margin-top: 20px; padding: 12px 24px; background-color: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em;">
            ğŸ“‚ è¼‰å…¥å·²å„²å­˜çš„æª”æ¡ˆ
        </button>
        
        <!-- åŒ¯å‡º/åŒ¯å…¥æŒ‰éˆ• -->
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button id="export-data-btn" style="flex: 1; padding: 10px 20px; background-color: #ff9800; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em;">
                ğŸ“¤ åŒ¯å‡ºè³‡æ–™
            </button>
            <button id="import-data-btn" style="flex: 1; padding: 10px 20px; background-color: #2196f3; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em;">
                ğŸ“¥ åŒ¯å…¥è³‡æ–™
            </button>
        </div>
        <input type="file" id="import-file-input" accept=".json" style="display: none;">
        
        <!-- ä¸Šå‚³é é¢çš„æª”æ¡ˆåˆ—è¡¨ -->
        <div id="upload-file-list" style="display: none; margin-top: 20px; max-width: 400px; background-color: rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 15px;">
            <h3 style="margin: 0 0 15px 0; color: white; text-align: center;">å·²å„²å­˜çš„æª”æ¡ˆ</h3>
            <div id="upload-saved-files"></div>
            <button id="close-list-btn" style="margin-top: 10px; padding: 8px 16px; background-color: #757575; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                é—œé–‰
            </button>
        </div>
        
        <div id="loading-spinner">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>
    </div>

    <!-- æª”æ¡ˆç®¡ç†å™¨ -->
    <div id="file-manager">
        <h3>å·²å„²å­˜çš„æª”æ¡ˆ</h3>
        <button id="save-current-btn" style="display: none;">å„²å­˜ç›®å‰æª”æ¡ˆ</button>
        <div id="saved-files-list"></div>
    </div>

    <!-- æª”æ¡ˆç®¡ç†å™¨åˆ‡æ›æŒ‰éˆ• -->
    <button id="toggle-manager-btn" style="display: none;">ğŸ“</button>

    <!-- é‡æ–°å‘½åå°è©±æ¡† -->
    <div id="rename-modal">
        <div id="rename-dialog">
            <h3>é‡æ–°å‘½åæª”æ¡ˆ</h3>
            <input type="text" id="rename-input" placeholder="è¼¸å…¥æ–°çš„æª”æ¡ˆåç¨±">
            <div id="rename-buttons">
                <button id="rename-confirm">ç¢ºèª</button>
                <button id="rename-cancel">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- 2. ç†ç‰ŒåŠ©æ‰‹ä»‹é¢ (æ‰€æœ‰æ±è¥¿éƒ½åœ¨é€™è£¡é¢) -->
    <div id="assistant-container">
        <div id="card-display">
            <div id="rank"></div>
            <div id="suit"></div>
        </div>
        <div id="status"></div>
        <div id="message"></div>
        <div id="controls">
            <div class="control-group">
                <label for="speed-slider">é€Ÿåº¦ (ç§’/å¼µ):</label>
                <input type="range" id="speed-slider" min="0.5" max="5" step="0.1" value="2.0">
                <span id="speed-value">2.0</span>
            </div>
            <button id="toggle-autoplay-btn">é–‹å§‹è‡ªå‹•æ’­æ”¾</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('file-input');
            const uploadContainer = document.getElementById('upload-container');
            const loadingSpinner = document.getElementById('loading-spinner');
            const assistantContainer = document.getElementById('assistant-container');
            const body = document.body;
            const rankDiv = document.getElementById('rank');
            const suitDiv = document.getElementById('suit');
            const statusDiv = document.getElementById('status');
            const messageDiv = document.getElementById('message');
            const speedSlider = document.getElementById('speed-slider');
            const speedValueSpan = document.getElementById('speed-value');
            const toggleAutoplayBtn = document.getElementById('toggle-autoplay-btn');
            
            // æª”æ¡ˆç®¡ç†ç›¸é—œå…ƒç´ 
            const fileManager = document.getElementById('file-manager');
            const toggleManagerBtn = document.getElementById('toggle-manager-btn');
            const saveCurrentBtn = document.getElementById('save-current-btn');
            const savedFilesList = document.getElementById('saved-files-list');
            const renameModal = document.getElementById('rename-modal');
            const renameInput = document.getElementById('rename-input');
            const renameConfirm = document.getElementById('rename-confirm');
            const renameCancel = document.getElementById('rename-cancel');
            
            // ä¸Šå‚³é é¢çš„æª”æ¡ˆåˆ—è¡¨ç›¸é—œå…ƒç´ 
            const loadSavedBtn = document.getElementById('load-saved-btn');
            const uploadFileList = document.getElementById('upload-file-list');
            const uploadSavedFiles = document.getElementById('upload-saved-files');
            const closeListBtn = document.getElementById('close-list-btn');
            
            let fullDeck = [];
            let currentIndex = -1;
            let autoplayTimer = null;
            let isAutoplaying = false;
            let currentFileName = '';
            let currentFileData = null;
            let renamingFileId = null;
            
            // äº‹ä»¶ç›£è½å™¨
            fileInput.addEventListener('change', handleFileSelect);
            document.addEventListener('keydown', handleKeyPress);
            speedSlider.addEventListener('input', handleSpeedChange);
            toggleAutoplayBtn.addEventListener('click', toggleAutoplay);
            toggleManagerBtn.addEventListener('click', toggleFileManager);
            saveCurrentBtn.addEventListener('click', saveCurrentFile);
            renameConfirm.addEventListener('click', confirmRename);
            renameCancel.addEventListener('click', cancelRename);
            loadSavedBtn.addEventListener('click', showUploadFileList);
            closeListBtn.addEventListener('click', hideUploadFileList);
            
            
            // åŒ¯å‡º/åŒ¯å…¥åŠŸèƒ½
            const exportDataBtn = document.getElementById('export-data-btn');
            const importDataBtn = document.getElementById('import-data-btn');
            const importFileInput = document.getElementById('import-file-input');
            
            // åŒ¯å‡ºè³‡æ–™
            exportDataBtn.addEventListener('click', function() {
                const savedFiles = JSON.parse(localStorage.getItem('savedExcelFiles') || '[]');
                if (savedFiles.length === 0) {
                    alert('ç›®å‰æ²’æœ‰å·²å„²å­˜çš„æª”æ¡ˆ');
                    return;
                }
                
                const dataStr = JSON.stringify(savedFiles, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'saved_excel_files_' + new Date().getTime() + '.json';
                link.click();
                URL.revokeObjectURL(url);
                alert('è³‡æ–™å·²åŒ¯å‡ºï¼è«‹å°‡æª”æ¡ˆå‚³é€åˆ°æ‰‹æ©Ÿå¾ŒåŒ¯å…¥ã€‚');
            });
            
            // é»æ“ŠåŒ¯å…¥æŒ‰éˆ•
            importDataBtn.addEventListener('click', function() {
                importFileInput.click();
            });
            
            // è™•ç†åŒ¯å…¥æª”æ¡ˆ
            importFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (!Array.isArray(importedData)) {
                            throw new Error('æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                        }
                        
                        // åˆä½µè³‡æ–™ï¼ˆé¿å…è¦†è“‹ç¾æœ‰æª”æ¡ˆï¼‰
                        const existingFiles = JSON.parse(localStorage.getItem('savedExcelFiles') || '[]');
                        const mergedFiles = [...existingFiles];
                        
                        importedData.forEach(importFile => {
                            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒ ID çš„æª”æ¡ˆ
                            const exists = mergedFiles.find(f => f.id === importFile.id);
                            if (!exists) {
                                mergedFiles.push(importFile);
                            }
                        });
                        
                        localStorage.setItem('savedExcelFiles', JSON.stringify(mergedFiles));
                        alert(`æˆåŠŸåŒ¯å…¥ ${importedData.length} å€‹æª”æ¡ˆï¼`);
                        loadSavedFiles();
                        updateUploadFileList();
                    } catch (error) {
                        alert('åŒ¯å…¥å¤±æ•—ï¼š' + error.message);
                    }
                };
                reader.readAsText(file);
                importFileInput.value = ''; // æ¸…ç©ºä»¥ä¾¿ä¸‹æ¬¡é¸æ“‡
            });
            // æ‹–æ”¾åŠŸèƒ½
            const uploadLabel = document.getElementById('upload-label');
            uploadLabel.addEventListener('dragover', handleDragOver);
            uploadLabel.addEventListener('dragleave', handleDragLeave);
            uploadLabel.addEventListener('drop', handleDrop);
            
            // è¼‰å…¥å·²å„²å­˜çš„æª”æ¡ˆ
            loadSavedFiles();
            updateUploadFileList();
            
            // æ‹–æ”¾è™•ç†å‡½æ•¸
            function handleDragOver(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadLabel.classList.add('drag-over');
            }
            
            function handleDragLeave(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadLabel.classList.remove('drag-over');
            }
            
            function handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadLabel.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.endsWith('.xlsx')) {
                        processFile(file);
                    } else {
                        alert('è«‹é¸æ“‡ Excel æª”æ¡ˆ (.xlsx)');
                    }
                }
            }
            
            async function processFile(file) {
                uploadContainer.style.display = 'none';
                loadingSpinner.style.display = 'block';
                
                try {
                    // å„²å­˜æª”æ¡ˆè³‡æ–™
                    currentFileName = file.name.replace('.xlsx', '');
                    currentFileData = await file.arrayBuffer();
                    
                    const deck = await parseExcelToDeck(file);
                    if (deck && deck.length > 0) {
                        startAssistant(deck);
                    } else {
                        throw new Error('ç„¡æ³•å¾ Excel ä¸­è§£æå‡ºä»»ä½•æœ‰æ•ˆçš„ç‰Œçµ„è³‡æ–™ã€‚');
                    }
                } catch (error) {
                    console.error('è§£æ Excel æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    alert(`è§£æå¤±æ•—ï¼š${error.message}`);
                    uploadContainer.style.display = 'block';
                    loadingSpinner.style.display = 'none';
                }
            }
            
            async function handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) { return; }
                await processFile(file);
            }
            async function parseExcelToDeck(file) {
                const deck = [];
                const reader = new FileReader();
                await new Promise((resolve, reject) => {
                    reader.onload = async (e) => {
                        try {
                            const buffer = e.target.result;
                            const wb = new ExcelJS.Workbook();
                            await wb.xlsx.load(buffer);
                            let ws = wb.getWorksheet('é è¦½') || wb.getWorksheet('Preview');
                            if (!ws) { throw new Error('æ‰¾ä¸åˆ°åç‚º "é è¦½" æˆ– "Preview" çš„å·¥ä½œè¡¨ã€‚'); }
                            const COLS = 15, ROWS = 28;
                            for (let r = 1; r <= ROWS; r++) {
                                for (let c = 1; c <= COLS; c++) {
                                    const sheetColIndex = c + Math.floor((c - 1) / 5);
                                    const cell = ws.getCell(r, sheetColIndex);
                                    const value = cell.value ? String(cell.value) : '';
                                    const fill = cell.fill;
                                    let backColor = null;
                                    if (fill && fill.fgColor && fill.fgColor.argb) {
                                        if (fill.fgColor.argb.toUpperCase() === 'FFFFFF00') backColor = 'R';
                                        else if (fill.fgColor.argb.toUpperCase() === 'FF00FFFF') backColor = 'B';
                                    }
                                    if (!value && !backColor) continue;
                                    const font = cell.font;
                                    let suit = 'â™ ';
                                    if (font && font.color && font.color.argb) {
                                        const fontColor = font.color.argb.toUpperCase();
                                        // åŒæ™‚æ”¯æ´æ¨™æº–ç´…è‰²(FFFF0000)å’Œæ·ºç´…è‰²(FFFF4D4F)
                                        if (fontColor === 'FFFF0000' || fontColor === 'FFFF4D4F') {
                                            suit = 'â™¥';
                                        }
                                    }
                                    let rank = value;
                                    if (value === '0') rank = 'K';
                                    if (value === '1') rank = 'A';
                                    deck.push({ rank, suit, back: backColor });
                                }
                            }
                            resolve();
                        } catch (err) { reject(err); }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
                return deck;
            }
            function startAssistant(deck) {
                fullDeck = deck;
                currentIndex = 0;
                loadingSpinner.style.display = 'none';
                uploadContainer.style.display = 'none';
                assistantContainer.style.display = 'flex';
                
                // é¡¯ç¤ºæª”æ¡ˆç®¡ç†ç›¸é—œæŒ‰éˆ•
                toggleManagerBtn.style.display = 'block';
                saveCurrentBtn.style.display = 'block';
                
                messageDiv.textContent = "æŒ‰ [ç©ºç™½éµ] æˆ– [â†’] æ‰‹å‹•ä¸‹ä¸€å¼µï¼Œæˆ–é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹è‡ªå‹•æ’­æ”¾";
                updateCardDisplay();
            }
            function updateCardDisplay() {
                if (currentIndex < 0 || currentIndex >= fullDeck.length) {
                    rankDiv.textContent = "å®Œæˆ";
                    suitDiv.textContent = "ğŸ‰";
                    statusDiv.textContent = `${fullDeck.length} / ${fullDeck.length}`;
                    body.className = '';
                    if (isAutoplaying) {
                        toggleAutoplay();
                    }
                    speak("å…¨éƒ¨æ’åˆ—å®Œæˆï¼Œè¾›è‹¦äº†ï¼");
                    return;
                }
                const card = fullDeck[currentIndex];
                body.className = card.back === 'R' ? 'bg-red-card' : 'bg-blue-card';
                rankDiv.textContent = card.rank;
                suitDiv.textContent = card.suit;
                rankDiv.className = "font-black";  // æ‰€æœ‰å­—é«”éƒ½ç”¨é»‘è‰²
                suitDiv.className = "font-black";  // æ‰€æœ‰èŠ±è‰²éƒ½ç”¨é»‘è‰²
                statusDiv.textContent = `${currentIndex + 1} / ${fullDeck.length}`;
                speakCard(card);
            }
            function handleKeyPress(event) {
                if (fullDeck.length === 0) return;
                if (isAutoplaying) {
                    toggleAutoplay();
                    return;
                }
                if (event.key === ' ' || event.key === 'ArrowRight') {
                    event.preventDefault();
                    advanceCard(1);
                } else if (event.key === 'ArrowLeft') {
                    event.preventDefault();
                    advanceCard(-1);
                }
            }
            function handleSpeedChange() {
                const speed = parseFloat(speedSlider.value).toFixed(1);
                speedValueSpan.textContent = speed;
                if (isAutoplaying) {
                    clearTimeout(autoplayTimer);
                    const interval = parseFloat(speedSlider.value) * 1000;
                    autoplayTimer = setTimeout(() => advanceCard(1, true), interval);
                }
            }
            function toggleAutoplay() {
                isAutoplaying = !isAutoplaying;
                if (isAutoplaying) {
                    toggleAutoplayBtn.textContent = 'æš«åœæ’­æ”¾';
                    toggleAutoplayBtn.style.backgroundColor = '#d93025';
                    messageDiv.textContent = "è‡ªå‹•æ’­æ”¾ä¸­... æŒ‰ä»»æ„éµå¯æš«åœ";
                    const interval = parseFloat(speedSlider.value) * 1000;
                    autoplayTimer = setTimeout(() => advanceCard(1, true), interval);
                } else {
                    clearTimeout(autoplayTimer);
                    toggleAutoplayBtn.textContent = 'ç¹¼çºŒè‡ªå‹•æ’­æ”¾';
                    toggleAutoplayBtn.style.backgroundColor = '#1a73e8';
                    messageDiv.textContent = "å·²æš«åœã€‚æŒ‰ [ç©ºç™½éµ] æ‰‹å‹•ä¸‹ä¸€å¼µï¼Œæˆ–é»æ“ŠæŒ‰éˆ•ç¹¼çºŒæ’­æ”¾";
                }
            }
            function advanceCard(direction, isFromAutoplay = false) {
                const newIndex = currentIndex + direction;
                if (newIndex >= 0 && newIndex <= fullDeck.length) {
                    currentIndex = newIndex;
                    updateCardDisplay();
                    if (isFromAutoplay && isAutoplaying && currentIndex < fullDeck.length) {
                        const interval = parseFloat(speedSlider.value) * 1000;
                        autoplayTimer = setTimeout(() => advanceCard(1, true), interval);
                    }
                }
            }
            function speakCard(card) {
                const backText = card.back === 'R' ? 'ç´…åº•' : 'é»‘åº•';
                
                // æ•¸å­—10ã€Jã€Qã€Kéƒ½å”¸æˆã€Œ0ã€
                let rankText = card.rank;
                if (rankText === '10' || rankText === 'J' || rankText === 'Q' || rankText === 'K') {
                    rankText = '0';
                }
                
                // åˆ¤æ–·æ˜¯å¦ç‚ºç´…è‰²å­—é«”ï¼ˆè¨Šè™Ÿç‰Œï¼‰
                const isRedSignal = (card.suit === 'â™¥');
                
                let textToSpeak;
                if (isRedSignal) {
                    // ç´…è‰²å­—é«”ï¼šå”¸ã€Œç´…åº•ï¼Œç´…Kã€ï¼ˆä½¿ç”¨é€—è™Ÿå¢åŠ åœé “ï¼‰
                    textToSpeak = `${backText}ï¼Œï¼Œç´…${rankText}`;  // å…©å€‹é€—è™Ÿå¢åŠ åœé “æ™‚é–“
                } else {
                    // é»‘è‰²å­—é«”ï¼šå”¸ã€Œç´…åº•ï¼ŒKã€
                    textToSpeak = `${backText}ï¼Œï¼Œ${rankText}`;  // å…©å€‹é€—è™Ÿå¢åŠ åœé “æ™‚é–“
                }
                
                speak(textToSpeak);
            }
            function speak(text) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 1.1;
                utterance.pitch = 1.0;
                window.speechSynthesis.speak(utterance);
            }
            
            // æª”æ¡ˆç®¡ç†åŠŸèƒ½
            function toggleFileManager() {
                if (fileManager.style.display === 'none' || !fileManager.style.display) {
                    fileManager.style.display = 'block';
                    loadSavedFiles();
                } else {
                    fileManager.style.display = 'none';
                }
            }
            
            function saveCurrentFile() {
                if (!currentFileData || !currentFileName) {
                    alert('æ²’æœ‰å¯å„²å­˜çš„æª”æ¡ˆ');
                    return;
                }
                
                const fileId = Date.now().toString();
                const savedFile = {
                    id: fileId,
                    name: currentFileName,
                    data: Array.from(new Uint8Array(currentFileData)),
                    savedDate: new Date().toLocaleString('zh-TW'),
                    deck: fullDeck
                };
                
                // å„²å­˜åˆ° localStorage
                const savedFiles = JSON.parse(localStorage.getItem('savedExcelFiles') || '[]');
                savedFiles.push(savedFile);
                localStorage.setItem('savedExcelFiles', JSON.stringify(savedFiles));
                
                alert(`æª”æ¡ˆ "${currentFileName}" å·²å„²å­˜`);
                loadSavedFiles();
                updateUploadFileList();
            }
            
            function loadSavedFiles() {
                const savedFiles = JSON.parse(localStorage.getItem('savedExcelFiles') || '[]');
                savedFilesList.innerHTML = '';
                
                savedFiles.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div class="file-name" onclick="loadSavedFile('${file.id}')">${file.name}</div>
                        <div class="file-actions">
                            <button class="file-btn rename-btn" onclick="startRename('${file.id}', '${file.name}')">é‡æ–°å‘½å</button>
                            <button class="file-btn delete-btn" onclick="deleteSavedFile('${file.id}')">åˆªé™¤</button>
                        </div>
                    `;
                    savedFilesList.appendChild(fileItem);
                });
            }
            
            window.loadSavedFile = function(fileId) {
                const savedFiles = JSON.parse(localStorage.getItem('savedExcelFiles') || '[]');
                const file = savedFiles.find(f => f.id === fileId);
                
                if (file) {
                    currentFileName = file.name;
                    currentFileData = new Uint8Array(file.data).buffer;
                    fullDeck = file.deck;
                    currentIndex = 0;
                    
                    uploadContainer.style.display = 'none';
                    loadingSpinner.style.display = 'none';
                    assistantContainer.style.display = 'flex';
                    toggleManagerBtn.style.display = 'block';
                    saveCurrentBtn.style.display = 'block';
                    fileManager.style.display = 'none';
                    
                    updateCardDisplay();
                    messageDiv.textContent = `å·²è¼‰å…¥æª”æ¡ˆ: ${file.name}`;
                }
            };
            
            window.startRename = function(fileId, currentName) {
                renamingFileId = fileId;
                renameInput.value = currentName;
                renameModal.style.display = 'block';
                renameInput.focus();
            };
            
            function confirmRename() {
                const newName = renameInput.value.trim();
                if (!newName) {
                    alert('è«‹è¼¸å…¥æª”æ¡ˆåç¨±');
                    return;
                }
                
                const savedFiles = JSON.parse(localStorage.getItem('savedExcelFiles') || '[]');
                const fileIndex = savedFiles.findIndex(f => f.id === renamingFileId);
                
                if (fileIndex !== -1) {
                    savedFiles[fileIndex].name = newName;
                    localStorage.setItem('savedExcelFiles', JSON.stringify(savedFiles));
                    loadSavedFiles();
                }
                
                renameModal.style.display = 'none';
                renamingFileId = null;
            }
            
            function cancelRename() {
                renameModal.style.display = 'none';
                renamingFileId = null;
            }
            
            window.deleteSavedFile = function(fileId) {
                if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æª”æ¡ˆå—ï¼Ÿ')) {
                    const savedFiles = JSON.parse(localStorage.getItem('savedExcelFiles') || '[]');
                    const filteredFiles = savedFiles.filter(f => f.id !== fileId);
                    localStorage.setItem('savedExcelFiles', JSON.stringify(filteredFiles));
                    loadSavedFiles();
                    updateUploadFileList();
                }
            };
            
            // ä¸Šå‚³é é¢çš„æª”æ¡ˆåˆ—è¡¨åŠŸèƒ½
            function showUploadFileList() {
                updateUploadFileList();
                uploadFileList.style.display = 'block';
                loadSavedBtn.style.display = 'none';
            }
            
            function hideUploadFileList() {
                uploadFileList.style.display = 'none';
                loadSavedBtn.style.display = 'block';
            }
            
            function updateUploadFileList() {
                const savedFiles = JSON.parse(localStorage.getItem('savedExcelFiles') || '[]');
                uploadSavedFiles.innerHTML = '';
                
                if (savedFiles.length === 0) {
                    uploadSavedFiles.innerHTML = '<div style="text-align: center; color: #aaa; padding: 20px;">å°šç„¡å·²å„²å­˜çš„æª”æ¡ˆ</div>';
                    return;
                }
                
                savedFiles.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 10px; margin: 5px 0; background-color: rgba(255, 255, 255, 0.1); border-radius: 5px; cursor: pointer;';
                    fileItem.innerHTML = `
                        <div style="color: #4fc3f7; flex: 1;" onclick="loadSavedFileFromUpload('${file.id}')">${file.name}</div>
                        <div style="font-size: 0.8em; color: #aaa;">${file.savedDate}</div>
                    `;
                    uploadSavedFiles.appendChild(fileItem);
                });
            }
            
            window.loadSavedFileFromUpload = function(fileId) {
                const savedFiles = JSON.parse(localStorage.getItem('savedExcelFiles') || '[]');
                const file = savedFiles.find(f => f.id === fileId);
                
                if (file) {
                    currentFileName = file.name;
                    currentFileData = new Uint8Array(file.data).buffer;
                    fullDeck = file.deck;
                    currentIndex = 0;
                    
                    // éš±è—ä¸Šå‚³ä»‹é¢ï¼Œé¡¯ç¤ºèªéŸ³åŠ©æ‰‹
                    uploadContainer.style.display = 'none';
                    loadingSpinner.style.display = 'none';
                    assistantContainer.style.display = 'flex';
                    toggleManagerBtn.style.display = 'block';
                    saveCurrentBtn.style.display = 'block';
                    
                    updateCardDisplay();
                    messageDiv.textContent = `å·²è¼‰å…¥æª”æ¡ˆ: ${file.name}`;
                }
            };
        });
    </script>
</body>
</html>