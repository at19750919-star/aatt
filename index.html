<!doctype html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WAA 理牌 v2.0</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="calc_widget.css">
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
</head>
<body>
    <main class="container">
        <!-- 主要 2x2 網格佈局 -->
        <div class="grid-main">
            <!-- 卡片一：設定與創建 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">參數設定</h3>
                    <div class="card-subtitle">設定生成參數</div>
                </div>
                <div class="card-body">
                    <div class="form-grid">
                        <div class="input-group"><label>靴數</label><input id="numShoes" type="number" min="1" max="8" value="1"></div>
                        <div class="input-group"><label>訊號規則</label>
                            <select id="signalRule">
                                <option value="suit" selected>花色（現行 ）</option>
                                <option value="red0">紅0（♥/♦ 的 0 點）</option>
                                <option value="backcolor">背色模式（BBBR/RRRB）</option>
                                <option value="zero0">0 點（任意花色）</option>
                            </select>
                        </div>
                        <div class="input-group"><label>訊號花色</label>
                            <select id="signalSuit">
                                <option value="H" selected>紅心</option>
                                <option value="S">黑桃</option>
                                <option value="D">方塊</option>
                                <option value="C">梅花</option>
                            </select>
                        </div>
                        <div class="input-group"><label>和局訊號</label>
                            <select id="tieSuit">
                                <option value="" selected>關閉</option>
                                <option value="H">紅心</option>
                                <option value="S">黑桃</option>
                                <option value="D">方塊</option>
                                <option value="C">梅花</option>
                            </select>
                        </div>
                        <div class="input-group"><label>層段</label><input id="multiPassMinCards" type="number" min="1" max="52" value="15"></div>
                        <div class="input-group"><label>功效</label><input id="gongxiao" type="number" value="0" placeholder="可留空"></div>
                    </div>
                    <button class="btn btn-primary" id="btnGen"><span id="spinGen" style="display:none" class="spinner"></span>創建</button>
                    <div class="small-text" id="genInfo"></div>
                </div>
            </div>

            <!-- 卡片二：即時儀表板 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">即時儀表板</h3>
                    <div class="card-subtitle">檢視牌靴結果與結構</div>
                </div>
                <div class="card-body">
                    <div id="bptSummary" class="bpt-summary"></div>
                    <div class="log-panel" id="warningsSignal" style="display:none;">
                        <div class="log-title">訊號警示（最高優先）</div>
                        <div class="log-body" id="warningsSignalBody"></div>
                    </div>
                    <div class="ticker-container" id="balance-ticker">
                        <!-- 跑馬燈內容將由 JS 動態生成 -->
                        <div class="ticker-content">牌庫結構完美平衡 ✔</div>
                    </div>
                </div>
            </div>

            <!-- 卡片三：牌局微調 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">牌局微調</h3>
                    <div class="card-subtitle">手動或自動優化牌局</div>
                </div>
                <div class="card-body">
                    <div class="btn-group">
                        <button class="btn" id="btnEdit">編輯</button>
                        <button class="btn" id="btnSwap">卡交換</button>
                        <button class="btn" id="btnRound">局交換</button>
                        <button class="btn" id="btnAutoSwap">卡色</button>
                        <button class="btn btn-secondary" id="btnCancelEdit">取消</button>
                    </div>
                    <button class="btn btn-confirm" id="btnApplyChanges">套用</button>
                </div>
            </div>

            <!-- 卡片四：導出與工具 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">導出與工具</h3>
                    <div class="card-subtitle">後續操作與輔助功能</div>
                </div>
                <div class="card-body">
                    <div class="input-group-inline">
                        <label>切牌張數:</label>
                        <input id="cutPos" type="number" min="0" value="0">
                        <button class="btn" id="btnCut"><span id="spinCut" style="display:none" class="spinner"></span>切牌</button>
                    </div>
                    <div class="btn-group">
                        <button class="btn" id="btnExportCombined">導出CSV</button>
                        <button class="btn" id="btnPreview">預覽</button>
                        <button class="btn" id="btnExportPreview">導出Excel</button>
                        <button class="btn" id="btnOpenAssistant">語音</button>
                        <button class="btn" id="btnCalcWidget" onclick="document.getElementById('floatingAssistant').style.display='block'">計算工具</button>
                    </div>
                    <div class="hotkey-hint">快捷鍵： G=創建, K=卡色, A=套用, C=切牌 ...</div>
                </div>
            </div>
        </div>

        <!-- 下方詳細表格與預覽 -->
        <div class="grid" id="tables" style="grid-template-columns:3fr 2fr;display:none">
            <section class="card" style="margin:0">
                <div class="card-header"><h3 class="card-title">詳細表格</h3></div>
                <div class="card-body">
                    <div class="table-wrap" style="max-height:85vh">
                        <table class="table" id="tbl"><thead id="thead"></thead><tbody id="tbody"></tbody></table>
                    </div>
                </div>
            </section>
            <section class="card" style="margin:0">
                <div class="card-header"><h3 class="card-title">預覽</h3></div>
                <div class="card-body">
                    <div id="gridPreview" class="grid-preview"></div>
                    <div class="stats" id="suits"></div>
                </div>
            </section>
        </div>
    </main>

    <!-- 原始 Toast 和 Modal (結構不變) -->
    <div class="toast" id="toast"></div>
    <div class="modal" id="previewModal">...</div>
    <script src="script.js"></script>
    <script src="signals.js"></script>
</body>
</html>
