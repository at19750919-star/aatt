<!doctype html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WAA 理牌 v2.0</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="light-theme.css">
    <link rel="stylesheet" href="calc_widget.css">
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
</head>
<body>
    <!-- 🎨 主題切換按鈕 -->
    <button class="theme-toggle" id="themeToggle" title="切換淺色/暗色主題">
        🌙
    </button>
    
    <main class="container">
        <!-- 主要 2x2 網格佈局 -->
        <div class="grid-main">
            <!-- 左上：卡片一：設定與創建 -->
            <div class="card">
                <div class="card-body">
                    <!-- 單行：六個輸入框 + 創建按鈕 -->
                    <div class="form-row-single">
                        <div class="input-group-compact">
                            <label>靴數</label>
                            <input id="numShoes" type="number" min="1" max="8" value="1">
                        </div>
                        <div class="input-group-compact">
                            <label>訊號規則</label>
                            <select id="signalRule">
                                <option value="suit" selected>花色</option>
                                <option value="red0">紅0（♥/♦ 的 0 點）</option>
                                <option value="backcolor">背色模式（BBBR/RRRB）</option>
                                <option value="zero0">0 點（任意花色）</option>
                            </select>
                        </div>
                        <div class="input-group-compact">
                            <label>訊號花色</label>
                            <select id="signalSuit">
                                <option value="H" selected>♥</option>
                                <option value="S">♠</option>
                                <option value="D">♦</option>
                                <option value="C">♣</option>
                            </select>
                        </div>
                        <div class="input-group-compact">
                            <label>和局訊號</label>
                            <select id="tieSuit">
                                <option value="" selected>關閉</option>
                                <option value="H">♥</option>
                                <option value="S">♠</option>
                                <option value="D">♦</option>
                                <option value="C">♣</option>
                            </select>
                        </div>
                        <div class="input-group-compact">
                            <label>層段</label>
                            <input id="multiPassMinCards" type="number" min="1" max="52" value="15">
                        </div>
                        <div class="input-group-compact">
                            <label>功效</label>
                            <input id="gongxiao" type="number" value="0" placeholder="可留空">
                        </div>
                        <div class="btn-group-compact">
                            <button class="btn btn-primary" id="btnGen"><span id="spinGen" style="display:none" class="spinner"></span>創建</button>
                        </div>
                    </div>
                    <div class="small-text" id="genInfo"></div>
                </div>
            </div>

            <!-- 右上：卡片四：導出與工具 -->
            <div class="card">
                <div class="card-body">
                    <!-- 單行：切牌輸入框 + 六個按鈕 -->
                    <div class="form-row-single">
                        <div class="input-group-compact">
                            <label>切牌張數</label>
                            <input id="cutPos" type="number" min="0" value="0">
                        </div>
                        <div class="btn-group-compact">
                            <button class="btn" id="btnCut"><span id="spinCut" style="display:none" class="spinner"></span>切牌</button>
                        </div>
                        <div class="btn-group-compact">
                            <button class="btn" id="btnExportCombined">合併Excel</button>
                        </div>
                        <div class="btn-group-compact">
                            <button class="btn" id="btnPreview">預覽</button>
                        </div>
                        <div class="btn-group-compact">
                            <button class="btn" id="btnExportPreview">導出Excel</button>
                        </div>
                        <div class="btn-group-compact">
                            <button class="btn" id="btnOpenAssistant">語音</button>
                        </div>
                        <div class="btn-group-compact">
                            <button class="btn" id="btnCalcWidget" onclick="document.getElementById('floatingAssistant').style.display='block'">計算工具</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 左下：卡片三：牌局微調 -->
            <div class="card">
                <div class="card-body">
                    <div class="btn-group">
                        <button class="btn" id="btnEdit">編輯</button>
                        <button class="btn" id="btnSwap">卡交換</button>
                        <button class="btn" id="btnRound">局交換</button>
                        <button class="btn" id="btnAutoSwap">卡色</button>
                        <button class="btn btn-secondary" id="btnCancelEdit">取消</button>
                        <button class="btn btn-confirm" id="btnApplyChanges">套用</button>
                        <button class="btn btn-image-only" id="btnTestImage" title="測試圖片（卡交換）"></button>
                        <button class="btn btn-warning" id="btnRedZeroPage" style="display: none;" title="跳轉到紅色0點牌專用頁面">紅0頁面</button>
                    </div>
                    <!-- 狀態訊息顯示區 -->
                    <div class="status-message" id="statusMessage" style="display: none;"></div>
                    <!-- 快捷鍵說明 -->
                    <div class="hotkey-info">
                        <div class="hotkey-row"><span class="hotkey-key">Z</span>=編輯 <span class="hotkey-key">X</span>=卡交換 <span class="hotkey-key">K</span>=卡色 <span class="hotkey-key">A</span>=套用 <span class="hotkey-key">G</span>=創建 <span class="hotkey-key">V</span>=預覽 <span class="hotkey-key">Esc</span>=取消</div>
                        <div class="hotkey-row"><span class="hotkey-key">C</span>=切牌 <span class="hotkey-key">U</span>=CSV導出 <span class="hotkey-key">Ctrl+X</span>=Excel匯出 <span class="hotkey-key">Ctrl+P</span>=列印 <span class="hotkey-key">Tab</span>=切換焦點 <span class="hotkey-key">?</span>=快捷鍵提示</div>
                    </div>
                </div>
            </div>

            <!-- 右下：卡片二：即時儀表板 -->
            <div class="card">
                <div class="card-body">
                    <div class="stats-ticker-row">
                        <div id="bptSummary" class="bpt-summary"></div>
                        <div class="ticker-container" id="balance-ticker">
                            <!-- 跑馬燈內容將由 JS 動態生成 -->
                            <div class="ticker-content">牌庫結構完美平衡 ✔</div>
                        </div>
                    </div>
                    <div class="log-panel" id="warningsSignal" style="display:none;">
                        <div class="log-title">訊號警示（最高優先）</div>
                        <div class="log-body" id="warningsSignalBody"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 下方詳細表格與預覽 -->
        <div class="grid" id="tables" style="grid-template-columns:1fr 1fr;display:none">
            <section class="card" style="margin:0">
                <div class="card-body">
                    <div class="table-wrap" style="max-height:1100px">
                        <table class="table" id="tbl"><thead id="thead"></thead><tbody id="tbody"></tbody></table>
                    </div>
                    <!-- 統計表格移到左邊 -->
                    <div class="stats" id="suits" style="margin-top:16px;"></div>
                </div>
            </section>
            <section class="card" style="margin:0">
                <div class="card-body">
                    <div id="gridPreview" class="grid-preview"></div>
                </div>
            </section>
        </div>
    </main>

    <!-- 原始 Toast 和 Modal (結構不變) -->
    <div class="toast" id="toast"></div>
    <div class="modal" id="previewModal">...</div>
    <script src="script.js"></script>
    <script src="signals.js"></script>
</body>
</html>